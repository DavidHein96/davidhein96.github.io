{
  "hash": "d3244ab060a2c6392465b78b64c3068e",
  "result": {
    "markdown": "---\ntitle: \"Adoption of a new Colorectal Cancer Treatment\"\nauthor: \"Dave Hein\"\ndate: \"2023-05-11\"\ncategories: [R, python, regression, synthetic data, oncology, data cleaning]\nimage: \"headshot.jpeg\"\nformat:\n  html: \n    toc: true\n    code-fold: show\n    code-tools: true\n---\n\n<style type=\"text/css\">\n\ncode.r{\n  font-size: 14px;\n}\ntd {\n  font-size: 12px;\n}\n\n</style>\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=8)\nlibrary(tidyverse)\nlibrary(haven)\nlibrary(lmtest)\nlibrary(glmnet)\nlibrary(nnet)\nlibrary(reticulate)\nlibrary(broom)\nlibrary(rmarkdown)\n#py_discover_config()\n#use_condaenv(\"website_env\")\n```\n:::\n\n\n## Creating Synthetic Data\n\n### Data cleaning and prep with R\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# We will use synthpop to generate a synthetic data set\nlibrary(synthpop)\n\n# Reading in original data from the NCDB\nRectalData <- read_dta(\"data_sets/ncdb_project_data.dta\")\n\ndf1 <- RectalData %>% select(RX_SUMM_SYSTEMIC_SUR_SEQ,\n                                 RX_SUMM_RADIATION, \n                                 RX_SUMM_SURGRAD_SEQ,\n                                 RX_SUMM_CHEMO,  \n                                 SEX,\n                                 MED_INC_QUAR_12, \n                                 AGE,\n                                 raceb, \n                                 TNM_CLIN_STAGE_GROUP,\n                                 TNM_PATH_STAGE_GROUP,\n                                 SEQUENCE_NUMBER, \n                                 HISTOLOGY, \n                                 RX_SUMM_SURG_PRIM_SITE, \n                                 YEAR_OF_DIAGNOSIS, \n                                 FACILITY_TYPE_CD, \n                                 INSURANCE_STATUS, \n                                 CDCC_TOTAL_BEST, \n                                 DX_DEFSURG_STARTED_DAYS,\n                                 CLASS_OF_CASE\n)\n\ndf1 <- df1 %>% \n  filter(!RX_SUMM_SYSTEMIC_SUR_SEQ %in% c(6,7,9), # unknown sequence  \n         !RX_SUMM_RADIATION == 9, # unknown if rad recommended, death cert only\n         !RX_SUMM_SURGRAD_SEQ %in% c(6, 9), # unknown sequence\n         !RX_SUMM_CHEMO %in% c(99,88), # unknown chemo\n          SEQUENCE_NUMBER %in% c(\"00\",\"01\"), # Primary cancer\n          HISTOLOGY %in% c(8140, 8210, 8260, 8261, 8262, 8263, 8470, 8480, 8481), # Proper histology codes\n          RX_SUMM_SURG_PRIM_SITE %in% c(30, 40, 50, 60, 70, 80)) # primary surgery\n\n# Make a simple stage variable and filter to only stage 2 and 3\ndf1 <- df1 %>% mutate(TNM_CLIN_STAGE_GROUP, stage3 = ifelse(str_detect(TNM_CLIN_STAGE_GROUP,\"2\"),\"2\",\"0\")) \ndf1$stage3[str_detect(df1$TNM_CLIN_STAGE_GROUP,\"3\") == TRUE] <- \"3\"\ndf1 <- df1[!(df1$stage3 ==\"0\"),]\n\n# Define neoadjuvant, rad or chemo before surgery \ndf1 <- df1 %>% mutate(neoadjuvant = 3)\ndf1 <- df1 %>% mutate(neoadjuvant = case_when(RX_SUMM_SURGRAD_SEQ %in% c(2,4) ~ 1,\n                                              RX_SUMM_SYSTEMIC_SUR_SEQ %in% c(2,4) ~ 1,\n                                              RX_SUMM_RADIATION==0 & RX_SUMM_CHEMO %in% c(0, 82, 85, 86, 87) ~ 0,\n                                              RX_SUMM_SURGRAD_SEQ==3 & RX_SUMM_CHEMO %in% c(0, 82, 85, 86, 87) ~ 0,\n                                              RX_SUMM_SYSTEMIC_SUR_SEQ==3 & df1$RX_SUMM_RADIATION==0 ~ 0,\n                                              RX_SUMM_SURGRAD_SEQ==3 & RX_SUMM_SYSTEMIC_SUR_SEQ==3 ~ 0\n                                              )) %>% filter(neoadjuvant != 3)\n\n# age group under 45, 45-65, 65 and up AGE\ndf1 <- df1 %>% mutate(agegroup= case_when(AGE<=45 ~0, AGE >45 & AGE <65 ~1, AGE >= 65 ~2))\n\n# create a var for switching facility and add the unknown gov insurance to unknown insurance \ndf1 <- df1 %>% mutate(CLASS_OF_CASE, treatnotatdiag = ifelse(CLASS_OF_CASE %in% c(0,20,21,22),\"Switched\",\"Stayed\"),\n                      INSURANCE_STATUS = ifelse(INSURANCE_STATUS==4,9,INSURANCE_STATUS))\n\n# Omit NA, this project used complete case analysis\ndf1 <- na.omit(df1)\n\n# Keep only relevant variables\ndf1 <- df1 %>% select(SEX,\n                      MED_INC_QUAR_12, \n                      agegroup,\n                      raceb, \n                      stage3,\n                      neoadjuvant,\n                      treatnotatdiag,\n                      YEAR_OF_DIAGNOSIS, \n                      FACILITY_TYPE_CD, \n                      INSURANCE_STATUS, \n                      CDCC_TOTAL_BEST, \n                      DX_DEFSURG_STARTED_DAYS\n)\n\n# Make variables into factors \ndf2 <- mutate(across(!DX_DEFSURG_STARTED_DAYS, as.factor))\n```\n:::\n\n\n### Data cleaning and prep with Python\n\n\n::: {.cell}\n\n:::\n\n\n### Generating and inspecting synthetic data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Make synthetic data using CART and bootstrapping\n\n# Reorder for synthetic data generation\ndf3 <- df2 %>%\n    dplyr::relocate(raceb, MED_INC_QUAR_12, neoadjuvant)\n\n# Strat by race and ethnicity and median income for best overlap\nsynth_1 <- syn.strata(df3, proper = TRUE, strata = df2$raceb)\nsynth_2 <- syn.strata(df3, proper = TRUE, strata = df3$MED_INC_QUAR_12)\n\nsynth_dat1 <- synth_1$syn\nsynth_dat2 <- synth_2$syn\n\nvars_i_want <- colnames(df2)\nvars_i_want <- vars_i_want[!vars_i_want == \"DX_DEFSURG_STARTED_DAYS\"]\n\n# Check Heat maps to compare\nsynthpop::utility.tables(synth_dat1, df3, tables = \"twoway\", vars = vars_i_want)\nsynthpop::utility.tables(synth_dat2, df3, tables = \"twoway\", vars = vars_i_want)\n\n# Remove Replicates\nfinal_synth_data <- sdc(synth_2, df3, label = \"synthetic\", rm.replicated.uniques = TRUE)\nf <- final_synth_data$syn\nwrite_tsv(f, \"synthetic_NCDB_data.tsv\")\n```\n:::\n\n\n## Analysis\n\n### Logistic regression for odds of upfront surgery (R)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load synthetic data\nsynthetic_NCDB_data <- read_delim(\"synthetic_NCDB_data.tsv\", delim = \"\\t\", escape_double = FALSE,\n    trim_ws = TRUE)\nsynthetic_NCDB_data <- synthetic_NCDB_data %>%\n    mutate(across(!DX_DEFSURG_STARTED_DAYS, as.factor))\n\n# logistic regression\nlog_fit <- glm(neoadjuvant ~ YEAR_OF_DIAGNOSIS + MED_INC_QUAR_12 + INSURANCE_STATUS +\n    raceb + CDCC_TOTAL_BEST + SEX + agegroup + stage3 + FACILITY_TYPE_CD + treatnotatdiag,\n    data = synthetic_NCDB_data, family = binomial(link = logit))\n\n# Tidy results\ntidy_log_fit <- data.frame(summary(log_fit)$coefficients)\n\nrmarkdown::paged_table(tidy_log_fit %>%\n    mutate(OR = exp(Estimate)) %>%\n    arrange(Pr...z..))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Estimate\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Std..Error\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"z.value\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Pr...z..\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"OR\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.4071841553\",\"2\":\"0.02883489\",\"3\":\"14.12123365\",\"4\":\"2.810282e-45\",\"5\":\"1.5025808\",\"_rn_\":\"treatnotatdiagSwitched\"},{\"1\":\"0.3495830840\",\"2\":\"0.02828529\",\"3\":\"12.35918313\",\"4\":\"4.345500e-35\",\"5\":\"1.4184760\",\"_rn_\":\"stage33\"},{\"1\":\"1.4275349110\",\"2\":\"0.11556431\",\"3\":\"12.35273173\",\"4\":\"4.708501e-35\",\"5\":\"4.1684110\",\"_rn_\":\"(Intercept)\"},{\"1\":\"-0.2802823441\",\"2\":\"0.02833066\",\"3\":\"-9.89325163\",\"4\":\"4.453235e-23\",\"5\":\"0.7555704\",\"_rn_\":\"SEX2\"},{\"1\":\"0.6817194541\",\"2\":\"0.07310896\",\"3\":\"9.32470485\",\"4\":\"1.112929e-20\",\"5\":\"1.9772746\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2016\"},{\"1\":\"0.5035962481\",\"2\":\"0.05771761\",\"3\":\"8.72517469\",\"4\":\"2.657700e-18\",\"5\":\"1.6546612\",\"_rn_\":\"FACILITY_TYPE_CD4\"},{\"1\":\"0.6183265466\",\"2\":\"0.07158919\",\"3\":\"8.63714922\",\"4\":\"5.763308e-18\",\"5\":\"1.8558198\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2015\"},{\"1\":\"0.3958305644\",\"2\":\"0.05003200\",\"3\":\"7.91154862\",\"4\":\"2.542066e-15\",\"5\":\"1.4856176\",\"_rn_\":\"FACILITY_TYPE_CD3\"},{\"1\":\"0.5490486249\",\"2\":\"0.07000185\",\"3\":\"7.84334452\",\"4\":\"4.387022e-15\",\"5\":\"1.7316048\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2014\"},{\"1\":\"0.5288362713\",\"2\":\"0.07050313\",\"3\":\"7.50089057\",\"4\":\"6.338569e-14\",\"5\":\"1.6969564\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2013\"},{\"1\":\"-0.5307671853\",\"2\":\"0.07173906\",\"3\":\"-7.39857978\",\"4\":\"1.376487e-13\",\"5\":\"0.5881536\",\"_rn_\":\"agegroup2\"},{\"1\":\"0.2747362904\",\"2\":\"0.04767374\",\"3\":\"5.76284270\",\"4\":\"8.270887e-09\",\"5\":\"1.3161835\",\"_rn_\":\"FACILITY_TYPE_CD2\"},{\"1\":\"-0.1869722169\",\"2\":\"0.03514557\",\"3\":\"-5.31993700\",\"4\":\"1.038032e-07\",\"5\":\"0.8294668\",\"_rn_\":\"CDCC_TOTAL_BEST1\"},{\"1\":\"-0.2044386612\",\"2\":\"0.06350889\",\"3\":\"-3.21905575\",\"4\":\"1.286135e-03\",\"5\":\"0.8151047\",\"_rn_\":\"agegroup1\"},{\"1\":\"0.1960413386\",\"2\":\"0.06828867\",\"3\":\"2.87077411\",\"4\":\"4.094680e-03\",\"5\":\"1.2165772\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2011\"},{\"1\":\"0.1893784554\",\"2\":\"0.06894265\",\"3\":\"2.74689857\",\"4\":\"6.016174e-03\",\"5\":\"1.2084982\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2010\"},{\"1\":\"0.1807849773\",\"2\":\"0.06796336\",\"3\":\"2.66003576\",\"4\":\"7.813236e-03\",\"5\":\"1.1981575\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2012\"},{\"1\":\"-0.2122599442\",\"2\":\"0.09849864\",\"3\":\"-2.15495309\",\"4\":\"3.116551e-02\",\"5\":\"0.8087544\",\"_rn_\":\"CDCC_TOTAL_BEST3\"},{\"1\":\"-0.1414070468\",\"2\":\"0.07094035\",\"3\":\"-1.99332333\",\"4\":\"4.622605e-02\",\"5\":\"0.8681359\",\"_rn_\":\"raceb3\"},{\"1\":\"-0.1399762067\",\"2\":\"0.07026595\",\"3\":\"-1.99209148\",\"4\":\"4.636102e-02\",\"5\":\"0.8693789\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2007\"},{\"1\":\"-0.1247161139\",\"2\":\"0.06666496\",\"3\":\"-1.87078969\",\"4\":\"6.137424e-02\",\"5\":\"0.8827475\",\"_rn_\":\"CDCC_TOTAL_BEST2\"},{\"1\":\"-0.1189478094\",\"2\":\"0.07941687\",\"3\":\"-1.49776509\",\"4\":\"1.341943e-01\",\"5\":\"0.8878541\",\"_rn_\":\"INSURANCE_STATUS3\"},{\"1\":\"-0.0995810108\",\"2\":\"0.06826345\",\"3\":\"-1.45877487\",\"4\":\"1.446271e-01\",\"5\":\"0.9052166\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2008\"},{\"1\":\"0.0420753041\",\"2\":\"0.04410280\",\"3\":\"0.95402797\",\"4\":\"3.400695e-01\",\"5\":\"1.0429730\",\"_rn_\":\"MED_INC_QUAR_122\"},{\"1\":\"-0.0702357129\",\"2\":\"0.08740054\",\"3\":\"-0.80360731\",\"4\":\"4.216238e-01\",\"5\":\"0.9321741\",\"_rn_\":\"INSURANCE_STATUS2\"},{\"1\":\"-0.0423669151\",\"2\":\"0.06758696\",\"3\":\"-0.62685039\",\"4\":\"5.307573e-01\",\"5\":\"0.9585180\",\"_rn_\":\"YEAR_OF_DIAGNOSIS2009\"},{\"1\":\"0.0296897748\",\"2\":\"0.05226497\",\"3\":\"0.56806262\",\"4\":\"5.699924e-01\",\"5\":\"1.0301349\",\"_rn_\":\"raceb2\"},{\"1\":\"-0.0508947306\",\"2\":\"0.11053489\",\"3\":\"-0.46044040\",\"4\":\"6.452001e-01\",\"5\":\"0.9503787\",\"_rn_\":\"INSURANCE_STATUS9\"},{\"1\":\"0.0199456614\",\"2\":\"0.04339328\",\"3\":\"0.45964858\",\"4\":\"6.457685e-01\",\"5\":\"1.0201459\",\"_rn_\":\"MED_INC_QUAR_124\"},{\"1\":\"0.0099215664\",\"2\":\"0.04354882\",\"3\":\"0.22782632\",\"4\":\"8.197813e-01\",\"5\":\"1.0099709\",\"_rn_\":\"MED_INC_QUAR_123\"},{\"1\":\"-0.0019922413\",\"2\":\"0.13181021\",\"3\":\"-0.01511447\",\"4\":\"9.879409e-01\",\"5\":\"0.9980097\",\"_rn_\":\"raceb4\"},{\"1\":\"-0.0009212353\",\"2\":\"0.07197409\",\"3\":\"-0.01279954\",\"4\":\"9.897877e-01\",\"5\":\"0.9990792\",\"_rn_\":\"INSURANCE_STATUS1\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n# ?paged_table\n```\n:::\n\n\n### Graphing proportion receiving upfront surg at different facility types over time\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Making df of just people who got upfront surg\nsynthetic_NCDB_data <- synthetic_NCDB_data %>%\n    mutate(neoadjuvant = as.numeric(neoadjuvant) - 1)\ndf2 <- synthetic_NCDB_data %>%\n    filter(neoadjuvant == 1)\n\n# renaming the fac type\ndfyear <- synthetic_NCDB_data %>%\n    dplyr::select(YEAR_OF_DIAGNOSIS, neoadjuvant, FACILITY_TYPE_CD)\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 1] <- \"Community Cancer Program\"\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Unknown or uninitialised column: `Facility_Type`.\n```\n:::\n\n```{.r .cell-code}\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 2] <- \"Comprehensive CC Program\"\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 3] <- \"Academic Program\"\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 4] <- \"Integrated Network Cancer Program\"\n\n\n# finding proportion of upfront surg by fac type\ndfyear <- dfyear %>%\n    dplyr::group_by(YEAR_OF_DIAGNOSIS, Facility_Type) %>%\n    dplyr::summarize(ratio = mean(neoadjuvant))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'YEAR_OF_DIAGNOSIS'. You can override using\nthe `.groups` argument.\n```\n:::\n\n```{.r .cell-code}\n# finding overall median per year of upfront surg\ndfyearavg <- synthetic_NCDB_data %>%\n    dplyr::group_by(YEAR_OF_DIAGNOSIS) %>%\n    dplyr::summarize(ratio = mean(neoadjuvant))\ndfyearavg$Facility_Type <- \"Overall Median\"\ndfyearavg <- dfyearavg %>%\n    select(YEAR_OF_DIAGNOSIS, Facility_Type, ratio)\n\n# Merging overall and by facility type\nyear1 <- as.data.frame(dfyear)\nyear2 <- as.data.frame(dfyearavg)\nmergedyearly <- rbind(year1, year2)\nmergedyearly$Facility_Type <- factor(mergedyearly$Facility_Type, levels = c(\"Integrated Network Cancer Program\",\n    \"Academic Program\", \"Overall Median\", \"Comprehensive CC Program\", \"Community Cancer Program\"))\n\n# plotting upfron surg by fac type\nggplot(mergedyearly) + geom_line(data = mergedyearly, aes(x = YEAR_OF_DIAGNOSIS,\n    y = ratio, group = Facility_Type, color = Facility_Type), size = 1.3) + labs(x = \"Year of Diagnosis\",\n    y = \"Proportion Receiving Upfront Surgery\", color = \"Facility Type\") + theme_test() +\n    scale_color_brewer(palette = \"Dark2\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=1152}\n:::\n:::\n\n\n### Looking at how delays in surgery and facility switching are linked\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# making three groups for a surgery delay\ndf2$surggroup[df2$DX_DEFSURG_STARTED_DAYS == 0] <- \"Day zero\"\ndf2$surggroup[df2$DX_DEFSURG_STARTED_DAYS > 0 & df2$DX_DEFSURG_STARTED_DAYS < 28] <- \"Short delay\"\ndf2$surggroup[df2$DX_DEFSURG_STARTED_DAYS >= 28] <- \"Long Delay\"\ndf2$surggroup <- factor(df2$surggroup)\n\n# plotting surg delay and switching facility\nggplot(df2, aes(x = DX_DEFSURG_STARTED_DAYS, fill = treatnotatdiag)) + geom_histogram(binwidth = 5) +\n    xlim(-10, 200) + labs(x = \"Days Untill Surgery From Diagnosis\", y = \"Count\",\n    fill = \"Facility Switch\") + theme_test() + scale_fill_brewer(palette = \"Set2\") +\n    geom_vline(xintercept = 28)\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=1152}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}