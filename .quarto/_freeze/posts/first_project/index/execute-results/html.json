{
  "hash": "c2c0e64125a46e6ad940e5d440b9f3c1",
  "result": {
    "markdown": "---\ntitle: \"tewst post\"\nauthor: \"Harlow Malloc\"\ndate: \"2023-05-11\"\ncategories: [news, code, analysis]\nimage: \"headshot.jpeg\"\npage-layout: full\nformat:\n  html: \n    toc: true\n    page-layout: full\n---\n\n::: {.cell}\n\n```{.r .cell-code}\nknitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=8)\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──\n✔ ggplot2 3.4.0      ✔ purrr   0.3.5 \n✔ tibble  3.1.8      ✔ dplyr   1.0.10\n✔ tidyr   1.2.1      ✔ stringr 1.5.0 \n✔ readr   2.1.3      ✔ forcats 0.5.2 \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\n```\n:::\n\n```{.r .cell-code}\nlibrary(haven)\nlibrary(lmtest)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: zoo\n\nAttaching package: 'zoo'\n\nThe following objects are masked from 'package:base':\n\n    as.Date, as.Date.numeric\n```\n:::\n\n```{.r .cell-code}\nlibrary(glmnet)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: Matrix\n\nAttaching package: 'Matrix'\n\nThe following objects are masked from 'package:tidyr':\n\n    expand, pack, unpack\n\nLoaded glmnet 4.1-6\n```\n:::\n\n```{.r .cell-code}\nlibrary(nnet)\n```\n:::\n\n\n### Selecting variables from NCDB data base that are useful\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Reading in data\nRectalData <- read_dta(\"data_sets/ncdb_project_data.dta\")\n\ndataset <- RectalData %>% select(\n                                           RX_SUMM_SYSTEMIC_SUR_SEQ,RX_SUMM_RADIATION, RX_SUMM_SURGRAD_SEQ,\n                                           RX_SUMM_CHEMO,  SEX,MED_INC_QUAR_12, AGE,\n                                           PUF_CASE_ID, raceb, TNM_CLIN_STAGE_GROUP,TNM_PATH_STAGE_GROUP,SEQUENCE_NUMBER, HISTOLOGY, \n                                           RX_SUMM_SURG_PRIM_SITE, YEAR_OF_DIAGNOSIS, FACILITY_TYPE_CD, INSURANCE_STATUS, CDCC_TOTAL_BEST, \n                                           DX_DEFSURG_STARTED_DAYS, CLASS_OF_CASE\n)\n\n#getting rid of NAs and Nulls\ndf1 <- dataset\ndf1 <- na.omit(dataset)\n```\n:::\n\n\n### Cleaning up data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#drop if missing RX_SUMM_SYSTEMIC_SUR_SEQ, interoperative, or sequence unknown\ndf1 <- df1[!(df1$RX_SUMM_SYSTEMIC_SUR_SEQ == 6 | df1$RX_SUMM_SYSTEMIC_SUR_SEQ == 7 | df1$RX_SUMM_SYSTEMIC_SUR_SEQ == 9),]\n\n#drop if RX_SUMM_RADIATION is unknown\ndf1 <- df1[!(df1$RX_SUMM_RADIATION ==9),]\n\n#drop if RX_SUMM_SURGRAD_SEQ is unkown or if interoperative\ndf1 <- df1[!(df1$RX_SUMM_SURGRAD_SEQ == 6 | df1$RX_SUMM_SURGRAD_SEQ == 9),]\n\t\n#drop if RX_SUMM_CHEMO is unknown or not mentioned\ndf1 <- df1[!(df1$RX_SUMM_CHEMO == 88 | df1$RX_SUMM_CHEMO == 99),]\n\n#drop if not stage 2 or 3 \ndf1 <- df1 %>% mutate(TNM_CLIN_STAGE_GROUP, stage3 = ifelse(   str_detect(TNM_CLIN_STAGE_GROUP,\"2\") == TRUE,\"2\",\"0\")) \ndf1$stage3[str_detect(df1$TNM_CLIN_STAGE_GROUP,\"3\") == TRUE] <- \"3\"\ndf1 <- df1[!(df1$stage3 ==\"0\"),]\n\n#sequence number\ndf1 <- df1[(df1$SEQUENCE_NUMBER ==\"00\" | df1$SEQUENCE_NUMBER ==\"01\"),]\n\n#drop if histology not adenocarcinoma 8140, 8210, 8260-63, 8470, 8480, and 8481\ndf1 <- df1[(df1$HISTOLOGY ==8140 | df1$HISTOLOGY ==8210 | df1$HISTOLOGY ==8260 | df1$HISTOLOGY ==8261 | df1$HISTOLOGY ==8262 | df1$HISTOLOGY ==8263 | df1$HISTOLOGY ==8480 | df1$HISTOLOGY ==8481),]\n\n#drop if did not get def surg \ndf1 <- df1[(df1$RX_SUMM_SURG_PRIM_SITE==40 | df1$RX_SUMM_SURG_PRIM_SITE==30 | df1$RX_SUMM_SURG_PRIM_SITE==50 | df1$RX_SUMM_SURG_PRIM_SITE==60 | df1$RX_SUMM_SURG_PRIM_SITE==70 | df1$RX_SUMM_SURG_PRIM_SITE==80),]\n```\n:::\n\n\n### Assigning new variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Assigning neo adjuvant if got rad OR chemo before surg\ndf1$surg4\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Unknown or uninitialised column: `surg4`.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nNULL\n```\n:::\n\n```{.r .cell-code}\ndf1$surg4[df1$RX_SUMM_SURGRAD_SEQ == 2 | df1$RX_SUMM_SURGRAD_SEQ == 4] <- 0\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Unknown or uninitialised column: `surg4`.\n```\n:::\n\n```{.r .cell-code}\ndf1$surg4[df1$RX_SUMM_SYSTEMIC_SUR_SEQ == 2 | df1$RX_SUMM_SYSTEMIC_SUR_SEQ == 4] <- 0\n\ndf1$surg4[df1$RX_SUMM_SYSTEMIC_SUR_SEQ==3 & df1$RX_SUMM_RADIATION==0] <- 1\ndf1$surg4[df1$RX_SUMM_SURGRAD_SEQ==3 & df1$RX_SUMM_CHEMO==0] <- 1\ndf1$surg4[df1$RX_SUMM_SURGRAD_SEQ==3 & df1$RX_SUMM_CHEMO==82] <- 1\ndf1$surg4[df1$RX_SUMM_SURGRAD_SEQ==3 & df1$RX_SUMM_CHEMO==85] <- 1\ndf1$surg4[df1$RX_SUMM_SURGRAD_SEQ==3 & df1$RX_SUMM_CHEMO==86] <- 1\ndf1$surg4[df1$RX_SUMM_SURGRAD_SEQ==3 & df1$RX_SUMM_CHEMO==87] <- 1\ndf1$surg4[df1$RX_SUMM_SURGRAD_SEQ==3 & df1$RX_SUMM_SYSTEMIC_SUR_SEQ==3] <- 1\ndf1$surg4[df1$RX_SUMM_RADIATION==0 & df1$RX_SUMM_CHEMO==0] <- 1\ndf1$surg4[df1$RX_SUMM_RADIATION==0 & df1$RX_SUMM_CHEMO==82] <- 1\ndf1$surg4[df1$RX_SUMM_RADIATION==0 & df1$RX_SUMM_CHEMO==85] <- 1\ndf1$surg4[df1$RX_SUMM_RADIATION==0 & df1$RX_SUMM_CHEMO==86] <- 1\ndf1$surg4[df1$RX_SUMM_RADIATION==0 & df1$RX_SUMM_CHEMO==87] <- 1\n\ndf1 <- na.omit(df1)\n\n#age group under 45, 45-65, 65 and up AGE\ndf1$agegroup\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Unknown or uninitialised column: `agegroup`.\n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\nNULL\n```\n:::\n\n```{.r .cell-code}\ndf1$agegroup[df1$AGE<=45]<-0\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Unknown or uninitialised column: `agegroup`.\n```\n:::\n\n```{.r .cell-code}\ndf1$agegroup[df1$AGE>=46]<-1\ndf1$agegroup[df1$AGE>=65]<-2\n\n#people who switch facility\ndf1 <- df1 %>% mutate(CLASS_OF_CASE, treatnotatdiag = ifelse(CLASS_OF_CASE == 0 | CLASS_OF_CASE == 22 | CLASS_OF_CASE == 20 | CLASS_OF_CASE == 21,\"Switched\",\"Stayed\") ) \n```\n:::\n\n\n### Logistic regression for odds of upfront surgery\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#logistic regression\n\n#making variable levels\ndf1$YEAR_OF_DIAGNOSIS <- factor(df1$YEAR_OF_DIAGNOSIS)\ndf1$MED_INC_QUAR_00 <- factor(df1$MED_INC_QUAR_12)\ndf1$INSURANCE_STATUS <- factor(df1$INSURANCE_STATUS)\ndf1$raceb <- factor(df1$raceb)\ndf1$CDCC_TOTAL_BEST <- factor(df1$CDCC_TOTAL_BEST)\ndf1$SEX  <- factor(df1$SEX )\ndf1$agegroup <- factor(df1$agegroup)\ndf1$stage3 <- factor(df1$stage3)\ndf1$FACILITY_TYPE_CD <- factor(df1$FACILITY_TYPE_CD)\ndf1$treatnotatdiag <- factor(df1$treatnotatdiag)\ndf1$stage3 <- relevel(df1$stage3, ref = \"3\")\ndf1 <- df1 %>% discard(is.null)\n   \n#regression\nfitlog <- glm(surg4 ~ YEAR_OF_DIAGNOSIS + MED_INC_QUAR_00  +INSURANCE_STATUS + raceb + CDCC_TOTAL_BEST + SEX + agegroup + stage3 + FACILITY_TYPE_CD + treatnotatdiag,  data = df1, family = binomial(link = logit))\n\n#significance\nsummary(fitlog)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\nCall:\nglm(formula = surg4 ~ YEAR_OF_DIAGNOSIS + MED_INC_QUAR_00 + INSURANCE_STATUS + \n    raceb + CDCC_TOTAL_BEST + SEX + agegroup + stage3 + FACILITY_TYPE_CD + \n    treatnotatdiag, family = binomial(link = logit), data = df1)\n\nDeviance Residuals: \n    Min       1Q   Median       3Q      Max  \n-1.1077  -0.5559  -0.4480  -0.3505   2.6807  \n\nCoefficients:\n                         Estimate Std. Error z value Pr(>|z|)    \n(Intercept)            -1.9300801  0.1156877 -16.684  < 2e-16 ***\nYEAR_OF_DIAGNOSIS2007  -0.0482599  0.0688244  -0.701 0.483176    \nYEAR_OF_DIAGNOSIS2008   0.1278204  0.0647430   1.974 0.048351 *  \nYEAR_OF_DIAGNOSIS2009   0.0457572  0.0648432   0.706 0.480400    \nYEAR_OF_DIAGNOSIS2010  -0.1243497  0.0651851  -1.908 0.056438 .  \nYEAR_OF_DIAGNOSIS2011  -0.1997043  0.0654059  -3.053 0.002263 ** \nYEAR_OF_DIAGNOSIS2012  -0.3544860  0.0664804  -5.332 9.70e-08 ***\nYEAR_OF_DIAGNOSIS2013  -0.5358786  0.0679307  -7.889 3.06e-15 ***\nYEAR_OF_DIAGNOSIS2014  -0.5978057  0.0675232  -8.853  < 2e-16 ***\nYEAR_OF_DIAGNOSIS2015  -0.6441496  0.0686324  -9.385  < 2e-16 ***\nYEAR_OF_DIAGNOSIS2016  -0.8873434  0.0729187 -12.169  < 2e-16 ***\nMED_INC_QUAR_002        0.0095261  0.0427649   0.223 0.823726    \nMED_INC_QUAR_003       -0.0231732  0.0426817  -0.543 0.587178    \nMED_INC_QUAR_004        0.0003867  0.0424679   0.009 0.992736    \nINSURANCE_STATUS1      -0.0421395  0.0717245  -0.588 0.556855    \nINSURANCE_STATUS2      -0.0761547  0.0890527  -0.855 0.392460    \nINSURANCE_STATUS3       0.1084414  0.0788630   1.375 0.169113    \nINSURANCE_STATUS4       0.0069946  0.1475180   0.047 0.962182    \nINSURANCE_STATUS9       0.2416326  0.1344264   1.798 0.072255 .  \nraceb2                  0.0386154  0.0519130   0.744 0.456968    \nraceb3                  0.0504678  0.0756183   0.667 0.504515    \nraceb4                  0.1962151  0.1351395   1.452 0.146517    \nCDCC_TOTAL_BEST1        0.1872961  0.0347827   5.385 7.25e-08 ***\nCDCC_TOTAL_BEST2        0.3218300  0.0644687   4.992 5.97e-07 ***\nCDCC_TOTAL_BEST3        0.5728939  0.0930981   6.154 7.57e-10 ***\nSEX2                    0.2660656  0.0276362   9.627  < 2e-16 ***\nagegroup1               0.2378698  0.0656151   3.625 0.000289 ***\nagegroup2               0.6592114  0.0736317   8.953  < 2e-16 ***\nstage32                 0.2813083  0.0275118  10.225  < 2e-16 ***\nFACILITY_TYPE_CD2      -0.1913698  0.0466157  -4.105 4.04e-05 ***\nFACILITY_TYPE_CD3      -0.3314190  0.0490509  -6.757 1.41e-11 ***\nFACILITY_TYPE_CD4      -0.5100541  0.0570620  -8.939  < 2e-16 ***\ntreatnotatdiagSwitched -0.3995306  0.0280350 -14.251  < 2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 38721  on 51561  degrees of freedom\nResidual deviance: 36843  on 51529  degrees of freedom\nAIC: 36909\n\nNumber of Fisher Scoring iterations: 5\n```\n:::\n\n```{.r .cell-code}\n#AOR and 95% CI\n    #exp(cbind(OR = coef(fitlog), confint(fitlog)))\n```\n:::\n\n\n### Graphing proportion receiving upfront surg at different facility types over time\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Making df of just people who got upfront surg\ndf1<-drop_na(df1)\ndf2 <- df1 %>% filter(surg4 ==1)\n\n#renaming the fac type\ndfyear <- df1 %>% dplyr::select(YEAR_OF_DIAGNOSIS, surg4, FACILITY_TYPE_CD)\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 1] <- \"Community Cancer Program\"\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Unknown or uninitialised column: `Facility_Type`.\n```\n:::\n\n```{.r .cell-code}\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 2] <- \"Comprehensive CC Program\"\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 3] <- \"Academic Program\"\ndfyear$Facility_Type[dfyear$FACILITY_TYPE_CD == 4] <- \"Integrated Network Cancer Program\"\n\n#finding proportion of upfront surg by fac type\ndfyear <- dfyear %>% dplyr::group_by(YEAR_OF_DIAGNOSIS,Facility_Type) %>% dplyr::summarize(ratio=mean(surg4))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n`summarise()` has grouped output by 'YEAR_OF_DIAGNOSIS'. You can override using\nthe `.groups` argument.\n```\n:::\n\n```{.r .cell-code}\n#finding overall median per year of upfront surg\ndfyearavg <- df1 %>% dplyr::group_by(YEAR_OF_DIAGNOSIS) %>% dplyr::summarize(ratio = mean(surg4))\ndfyearavg$Facility_Type <- \"Overall Median\"\ndfyearavg <- dfyearavg %>% select(YEAR_OF_DIAGNOSIS,Facility_Type,ratio)\n\n#Merging overall and by facility type\nyear1 <- as.data.frame(dfyear)\nyear2 <- as.data.frame(dfyearavg)\nmergedyearly <- rbind(year1,year2)\n\n#plotting upfron surg by fac type\nggplot(width=6) + geom_line(data = mergedyearly, aes(x=YEAR_OF_DIAGNOSIS, y=ratio, group = Facility_Type,color=Facility_Type),size = 2) + labs(x=\"Year of Diagnosis\", y = \"Proportion Receiving Upfront Surgery\", color = \"Facility Type\") +theme_test() +scale_color_brewer(palette = \"Dark2\") \n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nℹ Please use `linewidth` instead.\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-6-1.png){width=1152}\n:::\n:::\n\n\n### Looking at how delays in surgery and facility switching are linked\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#making three groups for a surgery delay \ndf2$surggroup[df2$DX_DEFSURG_STARTED_DAYS == 0] <- \"Day zero\"\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Unknown or uninitialised column: `surggroup`.\n```\n:::\n\n```{.r .cell-code}\ndf2$surggroup[df2$DX_DEFSURG_STARTED_DAYS > 0 & df2$DX_DEFSURG_STARTED_DAYS < 28] <- \"Short delay\"\ndf2$surggroup[df2$DX_DEFSURG_STARTED_DAYS >= 28] <- \"Long Delay\"\ndf2$surggroup <- factor(df2$surggroup)  \n  \n#plotting surg delay and switching facility\nggplot(df2,aes(x=DX_DEFSURG_STARTED_DAYS,fill=treatnotatdiag))+geom_histogram(binwidth = 5) + xlim(-10,200) + labs(x=\"Days Untill Surgery From Diagnosis\", y = \"Count\", fill = \"Facility Switch\")+theme_test() + scale_fill_brewer(palette = \"Set2\") + geom_vline(xintercept=28) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 114 rows containing non-finite values (`stat_bin()`).\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Removed 4 rows containing missing values (`geom_bar()`).\n```\n:::\n\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-7-1.png){width=1152}\n:::\n:::\n\n\n### Multinomial logistic regression\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#logistic regression for facoters involved in surg delay\ntest <- multinom(surggroup ~  CDCC_TOTAL_BEST  + FACILITY_TYPE_CD + treatnotatdiag, data = df2)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# weights:  27 (16 variable)\ninitial  value 7043.203383 \niter  10 value 6079.941779\niter  20 value 5907.743829\nfinal  value 5907.696322 \nconverged\n```\n:::\n\n```{.r .cell-code}\nsummary(test)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\nmultinom(formula = surggroup ~ CDCC_TOTAL_BEST + FACILITY_TYPE_CD + \n    treatnotatdiag, data = df2)\n\nCoefficients:\n            (Intercept) CDCC_TOTAL_BEST1 CDCC_TOTAL_BEST2 CDCC_TOTAL_BEST3\nLong Delay    0.8405949        0.2379591        0.3183511         1.639926\nShort delay   1.1511928        0.2179413        0.4104514         1.292843\n            FACILITY_TYPE_CD2 FACILITY_TYPE_CD3 FACILITY_TYPE_CD4\nLong Delay         0.12436555         0.4794398         0.1989572\nShort delay       -0.00914009        -0.2416883        -0.3256948\n            treatnotatdiagSwitched\nLong Delay                1.086307\nShort delay               0.583440\n\nStd. Errors:\n            (Intercept) CDCC_TOTAL_BEST1 CDCC_TOTAL_BEST2 CDCC_TOTAL_BEST3\nLong Delay    0.1285585        0.1107837        0.2101229        0.4632316\nShort delay   0.1258427        0.1123564        0.2107523        0.4693000\n            FACILITY_TYPE_CD2 FACILITY_TYPE_CD3 FACILITY_TYPE_CD4\nLong Delay          0.1396831         0.1494499         0.1702433\nShort delay         0.1372698         0.1498876         0.1713180\n            treatnotatdiagSwitched\nLong Delay              0.09634423\nShort delay             0.09885331\n\nResidual Deviance: 11815.39 \nAIC: 11847.39 \n```\n:::\n\n```{.r .cell-code}\n#z <- summary(test)$coefficients/summary(test)$standard.errors\n#p <- (1 - pnorm(abs(z), 0, 1)) * 2\n#p\n#exp(coef(test))\n#exp(confint(test))\n```\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}